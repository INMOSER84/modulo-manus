<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <data>
        
        <!-- Template: Reporte de rendimiento de técnicos -->
        <template id="technician_performance_document">
            <t t-call="web.html_container">
                <t t-foreach="docs" t-as="o">
                    <t t-call="web.external_layout">
                        <div class="page">
                            
                            <!-- Header -->
                            <div class="row mb-4">
                                <div class="col-8">
                                    <h2 class="text-primary">
                                        <strong>TECHNICIAN PERFORMANCE REPORT</strong>
                                    </h2>
                                    <h4><t t-esc="o.name"/></h4>
                                    <p class="text-muted">
                                        Employee ID: <t t-esc="o.x_inmoser_employee_code or 'N/A'"/>
                                        | Department: <t t-esc="o.department_id.name or 'N/A'"/>
                                    </p>
                                </div>
                                <div class="col-4 text-right">
                                    <div class="border p-3 bg-light">
                                        <h5 class="text-primary mb-0">Report Period</h5>
                                        <small>
                                            <t t-esc="(context_today() - datetime.timedelta(days=30)).strftime('%Y-%m-%d')"/>
                                            to <t t-esc="context_today().strftime('%Y-%m-%d')"/>
                                        </small>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Estadísticas principales -->
                            <div class="row mb-4">
                                <div class="col-3">
                                    <div class="card bg-primary text-white text-center">
                                        <div class="card-body">
                                            <h3><t t-esc="len(o.x_inmoser_service_order_ids.filtered(lambda s: s.state == 'done'))"/></h3>
                                            <small>Services Completed</small>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-3">
                                    <div class="card bg-success text-white text-center">
                                        <div class="card-body">
                                            <h3><t t-esc="round(o.service_efficiency, 1)"/>%</h3>
                                            <small>Efficiency Rate</small>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-3">
                                    <div class="card bg-info text-white text-center">
                                        <div class="card-body">
                                            <h3><t t-esc="round(o.avg_service_rating, 1)"/>/5</h3>
                                            <small>Avg. Rating</small>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-3">
                                    <div class="card bg-warning text-white text-center">
                                        <div class="card-body">
                                            <h3><t t-esc="round(o.monthly_service_hours, 1)"/>h</h3>
                                            <small>Monthly Hours</small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Servicios recientes -->
                            <div class="row mb-4">
                                <div class="col-12">
                                    <h5 class="text-primary">Recent Service Orders (Last 30 days)</h5>
                                    <t t-set="recent_services" t-value="o.x_inmoser_service_order_ids.filtered(lambda s: (datetime.datetime.now().date() - s.create_date.date()).days &lt;= 30)"/>
                                    
                                    <t t-if="recent_services">
                                        <table class="table table-sm">
                                            <thead class="thead-light">
                                                <tr>
                                                    <th>Order #</th>
                                                    <th>Customer</th>
                                                    <th>Equipment</th>
                                                    <th>Service Type</th>
                                                    <th>Status</th>
                                                    <th>Date</th>
                                                    <th>Rating</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                <t t-foreach="recent_services[:10]" t-as="service">
                                                    <tr>
                                                        <td><t t-esc="service.name"/></td>
                                                        <td><t t-esc="service.partner_id.name"/></td>
                                                        <td><t t-esc="service.equipment_id.name"/></td>
                                                        <td><t t-esc="service.service_type_id.name"/></td>
                                                        <td>
                                                            <span t-attf-class="badge badge-#{service.state == 'done' and 'success' or service.state == 'cancelled' and 'danger' or 'primary'}">
                                                                <t t-esc="dict(service._fields['state'].selection)[service.state]"/>
                                                            </span>
                                                        </td>
                                                        <td>
                                                            <t t-if="service.end_date">
                                                                <t t-esc="service.end_date" t-options="{'widget': 'date'}"/>
                                                            </t>
                                                            <t t-else="">
                                                                <t t-esc="service.scheduled_date" t-options="{'widget': 'date'}"/>
                                                            </t>
                                                        </td>
                                                        <td>
                                                            <t t-if="service.customer_satisfaction">
                                                                <t t-foreach="range(int(service.customer_satisfaction))" t-as="star">★</t>
                                                                <t t-foreach="range(5 - int(service.customer_satisfaction))" t-as="star">☆</t>
                                                            </t>
                                                            <t t-else="">-</t>
                                                        </td>
                                                    </tr>
                                                </t>
                                            </tbody>
                                        </table>
                                    </t>
                                    <t t-else="">
                                        <div class="alert alert-info">
                                            No service orders found in the last 30 days.
                                        </div>
                                    </t>
                                </div>
                            </div>
                            
                            <!-- Análisis de rendimiento -->
                            <div class="row mb-4">
                                <div class="col-6">
                                    <h5 class="text-primary">Performance Analysis</h5>
                                    <t t-set="completed_services" t-value="o.x_inmoser_service_order_ids.filtered(lambda s: s.state == 'done')"/>
                                    <t t-set="total_services" t-value="len(o.x_inmoser_service_order_ids)"/>
                                    
                                    <table class="table table-sm table-borderless">
                                        <tr>
                                            <td><strong>Total Services Assigned:</strong></td>
                                            <td><t t-esc="total_services"/></td>
                                        </tr>
                                        <tr>
                                            <td><strong>Services Completed:</strong></td>
                                            <td><t t-esc="len(completed_services)"/></td>
                                        </tr>
                                        <tr>
                                            <td><strong>Completion Rate:</strong></td>
                                            <td>
                                                <t t-if="total_services > 0">
                                                    <t t-esc="round((len(completed_services) / total_services) * 100, 1)"/>%
                                                </t>
                                                <t t-else="">0%</t>
                                            </td>
                                        </tr>
                                        <tr>
                                            <td><strong>Average Service Time:</strong></td>
                                            <td>
                                                <t t-if="completed_services">
                                                    <t t-set="avg_duration" t-value="sum(completed_services.mapped('duration')) / len(completed_services)"/>
                                                    <t t-esc="round(avg_duration, 1)"/> hours
                                                </t>
                                                <t t-else="">-</t>
                                            </td>
                                        </tr>
                                        <tr>
                                            <td><strong>Total Service Hours:</strong></td>
                                            <td><t t-esc="round(o.total_service_hours, 1)"/> hours</td>
                                        </tr>
                                    </table>
                                </div>
                                <div class="col-6">
                                    <h5 class="text-primary">Service Types Expertise</h5>
                                    <t t-set="service_types" t-value="{}"/>
                                    <t t-foreach="completed_services" t-as="service">
                                        <t t-set="service_type" t-value="service.service_type_id.name"/>
                                        <t t-if="service_type in service_types">
                                            <t t-set="service_types" t-value="dict(service_types, **{service_type: service_types[service_type] + 1})"/>
                                        </t>
                                        <t t-else="">
                                            <t t-set="service_types" t-value="dict(service_types, **{service_type: 1})"/>
                                        </t>
                                    </t>
                                    
                                    <t t-if="service_types">
                                        <table class="table table-sm">
                                            <thead class="thead-light">
                                                <tr>
                                                    <th>Service Type</th>
                                                    <th class="text-center">Count</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                <t t-foreach="sorted(service_types.items(), key=lambda x: x[1], reverse=True)" t-as="item">
                                                    <tr>
                                                        <td><t t-esc="item[0]"/></td>
                                                        <td class="text-center"><t t-esc="item[1]"/></td>
                                                    </tr>
                                                </t>
                                            </tbody>
                                        </table>
                                    </t>
                                    <t t-else="">
                                        <div class="alert alert-info">
                                            No completed services to analyze.
                                        </div>
                                    </t>
                                </div>
                            </div>
                            
                            <!-- Inventario virtual -->
                            <t t-if="o.virtual_inventory_ids">
                                <div class="row mb-4">
                                    <div class="col-12">
                                        <h5 class="text-primary">Current Virtual Inventory</h5>
                                        <table class="table table-sm">
                                            <thead class="thead-light">
                                                <tr>
                                                    <th>Product</th>
                                                    <th class="text-center">Allocated</th>
                                                    <th class="text-center">Available</th>
                                                    <th class="text-center">Used</th>
                                                    <th class="text-center">Status</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                <t t-foreach="o.virtual_inventory_ids" t-as="inventory">
                                                    <tr>
                                                        <td><t t-esc="inventory.product_id.name"/></td>
                                                        <td class="text-center"><t t-esc="inventory.allocated_quantity"/></td>
                                                        <td class="text-center"><t t-esc="inventory.available_quantity"/></td>
                                                        <td class="text-center"><t t-esc="inventory.used_quantity"/></td>
                                                        <td class="text-center">
                                                            <t t-if="inventory.available_quantity &lt;= inventory.min_quantity">
                                                                <span class="badge badge-danger">Low Stock</span>
                                                            </t>
                                                            <t t-else="">
                                                                <span class="badge badge-success">OK</span>
                                                            </t>
                                                        </td>
                                                    </tr>
                                                </t>
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </t>
                            
                            <!-- Recomendaciones -->
                            <div class="row mb-4">
                                <div class="col-12">
                                    <h5 class="text-primary">Performance Recommendations</h5>
                                    <div class="border p-3 bg-light">
                                        <t t-if="o.service_efficiency &lt; 70">
                                            <div class="alert alert-warning">
                                                <strong>Efficiency Improvement:</strong> Current efficiency is below 70%. 
                                                Consider time management training or workload adjustment.
                                            </div>
                                        </t>
                                        <t t-if="o.avg_service_rating &lt; 4">
                                            <div class="alert alert-info">
                                                <strong>Customer Satisfaction:</strong> Average rating is below 4/5. 
                                                Focus on customer communication and service quality.
                                            </div>
                                        </t>
                                        <t t-if="o.monthly_service_hours &lt; 120">
                                            <div class="alert alert-secondary">
                                                <strong>Utilization:</strong> Monthly hours are below target (120h). 
                                                Consider increasing service assignments.
                                            </div>
                                        </t>
                                        <t t-if="o.service_efficiency >= 85 and o.avg_service_rating >= 4.5">
                                            <div class="alert alert-success">
                                                <strong>Excellent Performance:</strong> This technician shows outstanding 
                                                performance in both efficiency and customer satisfaction.
                                            </div>
                                        </t>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Footer -->
                            <div class="row mt-4">
                                <div class="col-12 text-center">
                                    <small class="text-muted">
                                        Performance Report generated on <t t-esc="context_timestamp(datetime.datetime.now()).strftime('%Y-%m-%d %H:%M')"/>
                                        <br/>
                                        This report is confidential and for internal use only.
                                    </small>
                                </div>
                            </div>
                            
                        </div>
                    </t>
                </t>
            </t>
        </template>
        
    </data>
</odoo>

