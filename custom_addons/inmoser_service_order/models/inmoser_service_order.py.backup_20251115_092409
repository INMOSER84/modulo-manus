from odoo import models, fields, api, _

class InmoserServiceOrder(models.Model):
    _name = 'inmoser.service.order'
    _description = 'Inmoser Service Order'
    _order = 'date_scheduled desc'
    _rec_name = 'name'

    name = fields.Char(
        string='Order Reference', 
        required=True, 
        copy=False, 
        readonly=True, 
        index=True, 
        default=lambda self: _('New')
    )
    
    partner_id = fields.Many2one(
        'res.partner', 
        string='Customer', 
        required=True
    )
    
    equipment_id = fields.Many2one(
        'inmoser.service.equipment', 
        string='Equipment', 
        required=True, 
        ondelete='restrict'
    )
    
    service_type_id = fields.Many2one(
        'inmoser.service.type',
        string='Service Type',
        required=True
    )
    
    date_scheduled = fields.Datetime(
        string='Scheduled Date',
        help="Date when the service is scheduled to start."
    )

    assigned_technician_id = fields.Many2one(
        'hr.employee', 
        string='Assigned Technician',
        help="The technician assigned to this service order."
    )

    state = fields.Selection([
        ('draft', 'Draft'),
        ('confirmed', 'Confirmed'),
        ('in_progress', 'In Progress'),
        ('done', 'Done'),
        ('cancelled', 'Cancelled'),
    ], string='Status', readonly=True, copy=False, index=True,  default='draft')

    service_order_line_ids = fields.One2many(
        'inmoser.service.order.refaction.line', 
        'order_id', 
        string='Service Order Lines'
    )
    
    total_amount = fields.Monetary(
        string='Total Amount', 
        compute='_compute_total_amount', 
        store=True
    )
    
    currency_id = fields.Many2one(
        'res.currency', 
        string='Currency', 
        required=True, 
        default=lambda self: self.env.company.currency_id
    )
    
    date_start = fields.Datetime(string='Start Date', readonly=True)
    date_end = fields.Datetime(string='End Date', readonly=True)
    labor_hours = fields.Float(string='Labor Hours')
    labor_price = fields.Monetary(string='Labor Price')
    labor_total = fields.Monetary(string='Labor Total', compute='_compute_labor_total', store=True)
    diagnosis = fields.Text(string='Diagnosis')
    work_performed = fields.Text(string='Work Performed')
    invoice_id = fields.Many2one('account.move', string='Invoice', readonly=True)

    @api.depends('labor_hours', 'labor_price')
    def _compute_labor_total(self):
        for order in self:
            order.labor_total = order.labor_hours * order.labor_price

    @api.depends('service_order_line_ids.price_subtotal')
    def _compute_total_amount(self):
        for order in self:
            order.total_amount = sum(order.service_order_line_ids.mapped('price_subtotal'))

    @api.model_create_multi
    def create(self, vals_list):
        # Filtra los registros que necesitan una nueva secuencia
        vals_to_sequence = [vals for vals in vals_list if 'name' not in vals or vals['name'] == _('New')]
        if vals_to_sequence:
            # Pide todas las secuencias necesarias en un solo lote
            sequences = self.env['ir.sequence'].next_by_code('inmoser.service.order', sequence_number=len(vals_to_sequence))
            if not isinstance(sequences, list):
                sequences = [sequences]
            
            # Asigna las nuevas secuencias
            for vals, sequence in zip(vals_to_sequence, sequences):
                vals['name'] = sequence

        orders = super().create(vals_list)
        return orders

    # MÉTODOS DE TRANSICIÓN DE ESTADO
    def action_confirm(self):
        """Confirmar orden de servicio"""
        for record in self:
            if record.state == 'draft':
                record.state = 'confirmed'
                # Enviar notificación por correo
                template = self.env.ref('inmoser_service_order.email_template_customer_approval', raise_if_not_found=False)
                if template and record.partner_id.email:
                    template.send_mail(record.id, force_send=True)

    def action_assign(self):
        """Asignar técnico"""
        for record in self:
            if record.state == 'confirmed':
                record.state = 'assigned'

    def action_start(self):
        """Iniciar servicio"""
        for record in self:
            if record.state == 'assigned':
                record.state = 'in_progress'
                record.date_start = fields.Datetime.now()

    def action_complete(self):
        """Completar servicio"""
        for record in self:
            if record.state == 'in_progress':
                record.state = 'completed'
                record.date_end = fields.Datetime.now()

    def action_cancel(self):
        """Cancelar orden"""
        for record in self:
            if record.state in ['draft', 'confirmed', 'assigned', 'in_progress']:
                record.state = 'cancelled'

    def action_reset_to_draft(self):
        """Resetear a borrador"""
        for record in self:
            record.state = 'draft'
            record.date_start = False
            record.date_end = False

    # MÉTODO PARA GENERAR FACTURA
    def action_create_invoice(self):
        """Crear factura desde orden de servicio"""
        self.ensure_one()
        if self.invoice_id:
            raise UserError(_('Ya existe una factura para esta orden de servicio.'))
        
        # Crear factura
        invoice_vals = {
            'partner_id': self.partner_id.id,
            'move_type': 'out_invoice',
            'invoice_origin': self.name,
            'service_order_id': self.id,
            'invoice_line_ids': [(0, 0, {
                'name': f'Servicio: {self.service_type_id.name}',
                'quantity': 1,
                'price_unit': self.total_amount,
            })],
        }
        
        invoice = self.env['account.move'].create(invoice_vals)
        self.invoice_id = invoice.id
        
        return {
            'type': 'ir.actions.act_window',
            'name': 'Factura',
            'res_model': 'account.move',
            'res_id': invoice.id,
            'view_mode': 'form',
            'target': 'current',
        }
